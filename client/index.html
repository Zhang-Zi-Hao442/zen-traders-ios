<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zen Traders - 语音订单</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* 触觉反馈动画 */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse-animation {
            animation: pulse 1s ease-in-out infinite;
        }
        
        /* 录音动画 */
        @keyframes recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording-animation {
            animation: recording 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API配置
        const API_BASE_URL = 'http://localhost:3001/api';
        const WS_URL = 'ws://localhost:3001';

        // 图标组件
        const Icons = {
            Mic: ({ className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" x2="12" y1="19" y2="22"/>
                </svg>
            ),
            Check: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            ),
            X: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M18 6 6 18M6 6l12 12"/>
                </svg>
            ),
            Loader: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
            ),
            ShieldCheck: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    <path d="m9 12 2 2 4-4"/>
                </svg>
            ),
            Activity: () => (
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
            )
        };

        // 主应用组件
        const App = () => {
            const [voiceState, setVoiceState] = useState('idle'); // idle, listening, processing, awaiting_confirmation, executing
            const [transcript, setTranscript] = useState('');
            const [intent, setIntent] = useState(null);
            const [validation, setValidation] = useState(null);
            const [error, setError] = useState(null);
            const [orders, setOrders] = useState([]);
            const [positions, setPositions] = useState([]);
            const [leveragedPositions, setLeveragedPositions] = useState([]);
            const [leveragedGrouped, setLeveragedGrouped] = useState({});
            const [showLeveraged, setShowLeveraged] = useState(true);
            
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);
            const wsRef = useRef(null);
            const confirmationTimerRef = useRef(null);

            // 初始化WebSocket连接
            useEffect(() => {
                connectWebSocket();
                return () => {
                    if (wsRef.current) {
                        wsRef.current.close();
                    }
                };
            }, []);

            // 连接WebSocket
            const connectWebSocket = () => {
                try {
                    const ws = new WebSocket(WS_URL);
                    
                    ws.onopen = () => {
                        console.log('WebSocket connected');
                    };
                    
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    };
                    
                    ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        setError('连接错误，请检查服务器');
                    };
                    
                    ws.onclose = () => {
                        console.log('WebSocket closed');
                        // 尝试重连
                        setTimeout(connectWebSocket, 3000);
                    };
                    
                    wsRef.current = ws;
                } catch (error) {
                    console.error('Failed to connect WebSocket:', error);
                    setError('无法连接到服务器');
                }
            };

            // 处理WebSocket消息
            const handleWebSocketMessage = (data) => {
                switch (data.type) {
                    case 'status':
                        setVoiceState(data.state);
                        break;
                    case 'transcript':
                        setTranscript(data.transcript);
                        break;
                    case 'intent':
                        setIntent(data.intent);
                        break;
                    case 'validation':
                        setValidation(data.validation);
                        setIntent(data.intent);
                        break;
                    case 'order_executed':
                        handleOrderExecuted(data.order);
                        break;
                    case 'error':
                        setError(data.error);
                        setVoiceState('idle');
                        break;
                }
            };

            // 请求麦克风权限并开始录音
            const startRecording = async () => {
                try {
                    setError(null);
                    setTranscript('');
                    setIntent(null);
                    setValidation(null);
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    const mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    audioChunksRef.current = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunksRef.current.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        stream.getTracks().forEach(track => track.stop());
                        await sendAudioToServer();
                    };
                    
                    mediaRecorderRef.current = mediaRecorder;
                    mediaRecorder.start();
                    
                    setVoiceState('listening');
                    
                    // 通知WebSocket开始录音
                    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                        wsRef.current.send(JSON.stringify({ type: 'start_recording' }));
                    }
                    
                    // 触觉反馈
                    if (navigator.vibrate) {
                        navigator.vibrate([100]);
                    }
                    
                } catch (error) {
                    console.error('Recording error:', error);
                    setError('无法访问麦克风，请检查权限设置');
                    setVoiceState('idle');
                }
            };

            // 停止录音
            const stopRecording = () => {
                if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                    mediaRecorderRef.current.stop();
                    setVoiceState('processing');
                    
                    // 触觉反馈
                    if (navigator.vibrate) {
                        navigator.vibrate([50, 50, 50]);
                    }
                }
            };

            // 发送音频到服务器
            const sendAudioToServer = async () => {
                try {
                    const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                    
                    // 通过WebSocket发送（更实时）
                    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const base64Audio = reader.result.split(',')[1];
                            wsRef.current.send(JSON.stringify({
                                type: 'stop_recording',
                                audio: base64Audio
                            }));
                        };
                        reader.readAsDataURL(audioBlob);
                    } else {
                        // 备选方案：通过HTTP POST
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');
                        
                        const response = await fetch(`${API_BASE_URL}/voice/process`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            setTranscript(result.transcript);
                            setIntent(result.intent);
                            setValidation(result.validation);
                            
                            if (result.validation.isValid) {
                                setVoiceState('awaiting_confirmation');
                                startConfirmationTimer();
                            } else {
                                setVoiceState('idle');
                            }
                        } else {
                            setError(result.error || '处理失败');
                            setVoiceState('idle');
                        }
                    }
                } catch (error) {
                    console.error('Send audio error:', error);
                    setError('发送音频失败');
                    setVoiceState('idle');
                }
            };

            // 开始确认倒计时
            const startConfirmationTimer = () => {
                if (confirmationTimerRef.current) {
                    clearTimeout(confirmationTimerRef.current);
                }
                
                confirmationTimerRef.current = setTimeout(() => {
                    handleCancel();
                }, 10000); // 10秒后自动取消
            };

            // 确认订单
            const handleConfirm = async () => {
                try {
                    setVoiceState('executing');
                    
                    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                        wsRef.current.send(JSON.stringify({
                            type: 'confirm_order',
                            intent: intent
                        }));
                    } else {
                        // HTTP备选方案
                        const response = await fetch(`${API_BASE_URL}/orders/execute`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                intent: intent,
                                confirmation: 'confirmed'
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            handleOrderExecuted(result.order);
                        } else {
                            setError(result.error || '执行失败');
                            setVoiceState('awaiting_confirmation');
                        }
                    }
                    
                    if (confirmationTimerRef.current) {
                        clearTimeout(confirmationTimerRef.current);
                    }
                    
                    // 触觉反馈
                    if (navigator.vibrate) {
                        navigator.vibrate([200, 100, 200]);
                    }
                    
                } catch (error) {
                    console.error('Confirm error:', error);
                    setError('确认失败');
                    setVoiceState('awaiting_confirmation');
                }
            };

            // 取消订单
            const handleCancel = () => {
                setVoiceState('idle');
                setTranscript('');
                setIntent(null);
                setValidation(null);
                setError(null);
                
                if (confirmationTimerRef.current) {
                    clearTimeout(confirmationTimerRef.current);
                }
                
                if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                    wsRef.current.send(JSON.stringify({ type: 'cancel_order' }));
                }
            };

            // 处理订单执行成功
            const handleOrderExecuted = (order) => {
                setOrders(prev => [order, ...prev]);
                setVoiceState('idle');
                setTranscript('');
                setIntent(null);
                setValidation(null);
                
                // 播放成功提示音（可选）
                // playSuccessSound();
            };

            // 加载持仓信息
            useEffect(() => {
                loadPositions();
                loadLeveragedPositions();
            }, []);

            const loadPositions = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/positions`);
                    const result = await response.json();
                    if (result.success) {
                        setPositions(result.positions);
                    }
                } catch (error) {
                    console.error('Load positions error:', error);
                }
            };

            // 加载杠杆仓位
            const loadLeveragedPositions = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/positions/leveraged`);
                    const result = await response.json();
                    if (result.success) {
                        setLeveragedPositions(result.positions);
                        setLeveragedGrouped(result.grouped);
                    }
                } catch (error) {
                    console.error('Load leveraged positions error:', error);
                }
            };

            return (
                <div className="min-h-screen bg-black text-white pb-32">
                    {/* 错误提示 */}
                    {error && (
                        <div className="fixed top-4 left-4 right-4 z-50 bg-red-900/90 border border-red-700 rounded-xl p-4">
                            <p className="text-sm">{error}</p>
                            <button 
                                onClick={() => setError(null)}
                                className="mt-2 text-xs text-red-300 underline"
                            >
                                关闭
                            </button>
                        </div>
                    )}

                    {/* 头部 */}
                    <header className="p-6 pt-8">
                        <h1 className="text-3xl font-bold">Zen Traders</h1>
                        <p className="text-gray-500 text-sm mt-1">语音控制订单执行</p>
                    </header>

                    {/* 实时转录显示 */}
                    {transcript && (
                        <div className="px-4 mb-4">
                            <div className="bg-gray-900/60 border border-gray-800 rounded-2xl p-4">
                                <p className="text-xs text-gray-500 mb-2">实时转录</p>
                                <p className="text-white">{transcript}</p>
                            </div>
                        </div>
                    )}

                    {/* 杠杆仓位筛选展示 */}
                    <div className="px-4 mb-6">
                        <div className="flex items-center justify-between mb-3">
                            <h2 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2">
                                <span className="text-orange-500">⚡</span> 杠杆仓位
                                {leveragedPositions.length > 0 && (
                                    <span className="bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded-full text-[10px]">
                                        {leveragedPositions.length} 个
                                    </span>
                                )}
                            </h2>
                            <button 
                                onClick={() => loadLeveragedPositions()}
                                className="text-xs text-cyan-400 hover:text-cyan-300"
                            >
                                刷新
                            </button>
                        </div>
                        
                        {leveragedPositions.length > 0 ? (
                            <div className="space-y-2">
                                {leveragedPositions.map((pos, idx) => (
                                    <div key={idx} className="bg-gradient-to-r from-orange-900/30 to-gray-900/60 border border-orange-800/50 rounded-xl p-3">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-orange-400">{pos.symbol}</span>
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded ${
                                                        pos.leverageInfo?.type === 'Bull' 
                                                            ? 'bg-green-500/20 text-green-400' 
                                                            : 'bg-red-500/20 text-red-400'
                                                    }`}>
                                                        {pos.leverageInfo?.leverage} {pos.leverageInfo?.type}
                                                    </span>
                                                </div>
                                                <p className="text-[10px] text-gray-500 mt-0.5">
                                                    {pos.leverageInfo?.name}
                                                </p>
                                                <p className="text-[10px] text-gray-600">
                                                    追踪: {pos.leverageInfo?.underlying}
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <span className={`font-bold ${parseFloat(pos.unrealized_pl) >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                                                    {parseFloat(pos.unrealized_pl) >= 0 ? '+' : ''}${parseFloat(pos.unrealized_pl).toFixed(2)}
                                                </span>
                                                <p className="text-[10px] text-gray-500">
                                                    {Math.abs(parseFloat(pos.qty))} 股
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex justify-between mt-2 pt-2 border-t border-gray-800/50 text-[10px] text-gray-500">
                                            <span>成本: ${parseFloat(pos.avg_entry_price).toFixed(2)}</span>
                                            <span>现价: ${parseFloat(pos.current_price).toFixed(2)}</span>
                                            <span className={parseFloat(pos.unrealized_plpc) >= 0 ? 'text-green-500' : 'text-red-500'}>
                                                {(parseFloat(pos.unrealized_plpc) * 100).toFixed(2)}%
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-gray-900/40 border border-gray-800 rounded-xl p-4 text-center">
                                <p className="text-gray-500 text-sm">暂无杠杆仓位</p>
                                <p className="text-gray-600 text-xs mt-1">持有 TQQQ、SOXL 等杠杆 ETF 时会在此显示</p>
                            </div>
                        )}
                    </div>

                    {/* 全部持仓信息 */}
                    {positions.length > 0 && (
                        <div className="px-4 mb-6">
                            <h2 className="text-xs font-bold text-gray-500 mb-3 uppercase">全部持仓</h2>
                            <div className="space-y-2">
                                {positions.slice(0, 5).map((pos, idx) => (
                                    <div key={idx} className="bg-gray-900/60 border border-gray-800 rounded-xl p-3">
                                        <div className="flex justify-between">
                                            <span className="font-bold">{pos.symbol}</span>
                                            <span className={parseFloat(pos.unrealized_pl) >= 0 ? 'text-green-500' : 'text-red-500'}>
                                                {parseFloat(pos.unrealized_pl) >= 0 ? '+' : ''}{parseFloat(pos.unrealized_pl).toFixed(2)}
                                            </span>
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            数量: {Math.abs(parseFloat(pos.qty))} | 成本: ${parseFloat(pos.avg_entry_price).toFixed(2)}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* 状态覆盖层 */}
                    {voiceState === 'listening' && (
                        <div className="fixed top-24 left-4 right-4 z-40 bg-gray-900/90 backdrop-blur-md border border-gray-800 rounded-2xl p-6">
                            <p className="text-lg font-bold mb-1">正在聆听...</p>
                            <p className="text-gray-400 text-sm">请清晰地说明您的订单</p>
                        </div>
                    )}

                    {voiceState === 'processing' && (
                        <div className="fixed bottom-8 left-4 right-4 z-40 bg-gradient-to-r from-pink-600 to-rose-600 rounded-2xl p-4 py-5 flex items-center justify-center gap-3">
                            <Icons.Loader />
                            <span className="font-bold text-lg">处理中...</span>
                        </div>
                    )}

                    {/* 确认模态框 */}
                    {voiceState === 'awaiting_confirmation' && intent && validation && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center px-4 bg-black/80 backdrop-blur-sm">
                            <div className="w-full max-w-sm bg-gray-900 border border-gray-800 rounded-3xl overflow-hidden shadow-2xl">
                                <div className="p-6">
                                    <div className="flex items-center gap-2 text-emerald-400 mb-4">
                                        <Icons.ShieldCheck />
                                        <span className="font-bold text-lg text-white">确认订单</span>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div className="bg-gray-800/50 p-3 rounded-xl border border-gray-800">
                                            <p className="text-[10px] text-gray-500 uppercase font-bold mb-1">股票代码</p>
                                            <p className="font-bold text-cyan-400">{intent.symbol}</p>
                                        </div>
                                        <div className="bg-gray-800/50 p-3 rounded-xl border border-gray-800">
                                            <p className="text-[10px] text-gray-500 uppercase font-bold mb-1">类型</p>
                                            <p className="font-bold">{intent.side === 'buy' ? '买入' : '卖出'} {intent.type === 'market' ? '市价' : '限价'}</p>
                                        </div>
                                        <div className="bg-gray-800/50 p-3 rounded-xl border border-gray-800">
                                            <p className="text-[10px] text-gray-500 uppercase font-bold mb-1">数量</p>
                                            <p className="font-bold">{intent.quantity}</p>
                                        </div>
                                        <div className="bg-gray-800/50 p-3 rounded-xl border border-gray-800">
                                            <p className="text-[10px] text-gray-500 uppercase font-bold mb-1">价格</p>
                                            <p className="font-bold text-white">
                                                {intent.limitPrice ? `$${intent.limitPrice}` : '市价'}
                                            </p>
                                        </div>
                                    </div>

                                    {validation.warnings.length > 0 && (
                                        <div className="mb-4 p-3 bg-yellow-900/20 border border-yellow-800 rounded-xl">
                                            {validation.warnings.map((warning, idx) => (
                                                <p key={idx} className="text-xs text-yellow-400">{warning}</p>
                                            ))}
                                        </div>
                                    )}

                                    <div className="flex gap-3">
                                        <button 
                                            onClick={handleCancel}
                                            className="flex-1 py-4 rounded-xl bg-gray-800 hover:bg-gray-700 text-white font-bold flex items-center justify-center gap-2"
                                        >
                                            <Icons.X />
                                            取消
                                        </button>
                                        <button 
                                            onClick={handleConfirm}
                                            className="flex-1 py-4 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-black font-bold flex items-center justify-center gap-2"
                                        >
                                            <Icons.Check />
                                            确认执行
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 浮动录音按钮 */}
                    <div className="fixed bottom-8 left-0 right-0 px-4 z-30">
                        <button 
                            onMouseDown={startRecording}
                            onMouseUp={stopRecording}
                            onTouchStart={startRecording}
                            onTouchEnd={stopRecording}
                            className={`w-full bg-white text-black font-bold py-4 rounded-3xl flex items-center justify-center gap-3 shadow-xl transition-all ${
                                voiceState === 'listening' 
                                    ? 'bg-red-500 text-white pulse-animation' 
                                    : voiceState !== 'idle' 
                                        ? 'opacity-50 pointer-events-none' 
                                        : 'active:scale-95'
                            }`}
                            disabled={voiceState !== 'idle'}
                        >
                            <Icons.Mic className={voiceState === 'listening' ? 'recording-animation' : ''} />
                            <span className="text-lg">
                                {voiceState === 'listening' ? '正在录音...' : '按住说话'}
                            </span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
